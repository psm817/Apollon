<!DOCTYPE html>
<html layout:decorate="~{layout}">
<div layout:fragment="content" class="box">
    <div class="container">
        <div class="welcome-box">
            <span th:text="'회원 가입을 진행중입니다... 😂'"></span>
        </div>
        <div class="signup-form">
            <div class="input-box">
                <form th:action="@{/member/signup2}" method="POST" enctype="multipart/form-data">
                    <div class="id-box">
                        <span class="font-weight">ID</span>
                        <div class="chk-id">
                            <input type="text" id="username" maxlength="20" name="username" placeholder="ID를 입력하세요.">
                            <!-- Add a button to check for duplicate username -->
                            <button type="button" onclick="validateForm()">중복확인</button>
                            <div class="error-box">
                                <div id="signupError" th:text="${signupError}" class="error"></div>
                            </div>
                        </div>
                    </div>
                    <div class="password-box">
                        <span>비밀번호</span>
                        <input type="password" name="password" maxlength="20" placeholder="비밀번호를 입력하세요.">
                    </div>
                    <div class="password-confirm-box">
                        <span>비밀번호 확인</span>
                        <input type="password" name="password_confirm" maxlength="20" placeholder="비밀번호를 한번 더 입력하세요.">
                    </div>
                    <div class="nickname-box">
                        <div class="nickname-info">
                            <span>닉네임</span>
                            <span>(※ 등록하신 닉네임은 스튜디오 이름과 일치합니다.)</span>
                        </div>
                        <input type="text" name="nickname" placeholder="닉네임을 입력하세요.">
                    </div>
                    <div class="email-box">
                        <span>이메일</span>
                        <input type="email" name="email" placeholder="이메일을 입력하세요.">
                    </div>
                    <div class="profile-picture-box">
                        <span>프로필 사진</span>
                        <input type="file" name="profilePicture" onchange="imagecheck()">
                    </div>
                    <div class="error-box1">
                        <div id="profilePictureError" th:text="${profilePictureError}" class="error1"></div>
                    </div>
                    <div class="signup-btn">
                        <button type="button" onclick="if(confirm('회원 가입을 취소하시겠습니까?')) { window.location.href='/'; }">취소</button>
                        <button type="submit" id="submitButton">가입</button>
                        <img id="profilePicturePreview" src="#" alt="프로필 사진 미리보기" style="display: none; max-width: 260px; max-height: 2600px;">
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
</html>
<script>
    function validateForm() {
        const signupError = document.getElementById("signupError");
        const submitButton = document.getElementById("submitButton");
        const usernameInput = document.getElementById("username");
        // Get the value of the username input field
        const username = usernameInput.value.trim();
        // Check if the username is not empty
        if (username !== "") {
            // Send an AJAX request to the server to check for duplicate username
            fetch("/member/check-username?username=" + username)
                .then(response => response.json())
                .then(data => {
                    if (data.exists) {
                        signupError.innerText = "(이미 존재하는 아이디입니다.)";
                        signupError.classList.remove("success");
                        signupError.classList.add("error");
                        submitButton.disabled = true;
                    } else {
                        signupError.innerText = "(입력하신 아이디는 사용 가능합니다.)";
                        signupError.classList.remove("error");
                        signupError.classList.add("success");
                        submitButton.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
    }

   function imagecheck() {
        const submitButton = document.getElementById("submitButton");
        const image = document.querySelector('input[type="file"]').value;
        const profilePictureError = document.getElementById("profilePictureError");

        if (image === "") {
            submitButton.disabled = true;
            profilePictureError.innerText = "프로필 사진을 첨부해주세요."; // 에러 메시지 표시
        } else {
            submitButton.disabled = false;
            profilePictureError.innerText = ""; // 에러 메시지 지우기
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        validateForm();
        document.querySelector('input[type="file"]').addEventListener('change', function () {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('profilePicturePreview').src = e.target.result;
                document.getElementById('profilePicturePreview').style.display = 'block';
            };
            reader.readAsDataURL(this.files[0]);
        });
    });
</script>
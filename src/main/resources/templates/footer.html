<nav th:fragment="footerFragment" class="footer">
    <div class="footer_container">
        <div class="footer_play_box">
            <div class="music_myPlayList_box">
                <div class="myPlayList-btn_icon">
                    <i class="fa-solid fa-angle-up fa-2x" onclick="handlePlaylist()"></i>
                    <i class="fa-solid fa-angle-down fa-2x" onclick="handlePlaylist()"></i>
                </div>
            </div>
            <div class="footer_play_detail">
                <!-- 플레이바 왼쪽 박스 -->
                <div class="footer_play_playBar">
                    <!-- 이전 곡, 재생, 이후 곡, 셔플, 반복 -->
                    <div class="playSetting">
                        <!-- 이전 곡 아이콘 -->
                        <div class="growSet BeforeMusic_icon">
                            <i class="fa-solid fa-backward-step fa-lg"></i>
                        </div>
                        <!-- 이후 곡 아이콘 -->
                        <div class="growSet afterMusic_icon">
                            <i class="fa-solid fa-forward-step fa-lg"></i>
                        </div>
                        <!-- 셔플 아이콘 -->
                        <div class="growSet shuffleMusic_icon">
                            <i class="fa-solid fa-shuffle fa-lg" onclick="toggleShuffle()"></i>
                        </div>
                        <!-- 반복 아이콘 -->
                        <div class="growSet loopMusic_icon">
                            <div class="btn-box">
                                <i class="material-icons fa-solid fa-repeat fa-lg repeat" onclick="handleRepeat(this)"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 플레이바 중간 박스 -->
                <div class="footer_play_musicMiddle">
                    <div class="musicMiddle_column">
                        <!-- 곡 타임라인 -->
                        <div class="music_timeLine">
                            <div class="timeLine_bar">
                                <div class="music-box">
                                    <!-- 재생 중인 시간 -->
                                    <span class="current-time">0:00</span>
                                    <!-- 타임라인 seekbar -->
                                    <input type="range" step="1" class="seekbar" value="0" min="0" max="100" oninput="handleSeekBar()">
                                    <!-- 전체 재생 시간 -->
                                    <span class="duration">0:00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 볼륨 -->
                    <div class="volume-box">
                        <span class="volume-down" onclick="handleVolumeDown()"><i class="material-icons fa-solid fa-minus fa-lg"></i></span>
                        <input type="range" class="volume-range" step="1" value="80" min="0" max="100" oninput="handleVolume()">
                        >
                        <span class="volume-up" onclick="handleVolumeUp()"><i class="material-icons fa-solid fa-plus fa-lg"></i></span>
                    </div>
                    <div class="btn-box">
                        <i class="material-icons fa-solid fa-volume-low fa-lg volume" onclick="toggleVolume()"></i>
                    </div>
                </div>
                <------>
                <div class="footer_play_musicRight">
                    <img th:src="@{/images/ApollonLogo.png}" alt="로고사진">
                </div>
            </div>
            <!-- 내 플레이 리스트 보기 -->
            <div class="show_myPlayList" id="myPlayList">
                <div class="show_myPlayList_list">
                    <ul>
                        <!-- 타임리프를 사용하여 memberMusic 변수에 저장된 음악 데이터를 반복하여 출력 -->
                        <li sec:authorize="isAuthenticated()" class="show_myPlayList_list-num"
                            th:each="playlist : ${playList}">
                            <div class="myPlayList_musicTitle" th:each="music, iterStat : ${playlist.musicPlayList}">
                                <div class="number">
                                    <span th:text="${iterStat.index + 1}"></span>
                                </div>
                                <div class="myPlayList-thumbImg">
                                    <img th:src="${music.thumbnailImg}" alt="사진 없음">
                                </div>
                                <a class="myPlayList-musicTi" th:href="@{/chart/music/detail/{id}(id=${music.id})}"
                                   th:text="${music.musicTitle}"></a>
                                <a th:href="@{|/playlist/delete/${playlist.id}/${music.id}|}"
                                   class="music-delete-btn">
                                    <span>삭제</span>
                                </a>
                                <div class="music_play" data-music-src="${music.musicMp3}">
                  <span class="play-pause">
                    <i class="fa-solid fa-play"></i>
                    <i class="fa-solid fa-pause fa-lg" style="display: none;"></i>
                  </span>
                                    <audio id="audio" style="display: none;">
                                        <source th:src="${music.musicMp3}" type="audio/mp3">
                                    </audio>
                                </div>
                            </div>
                        </li>
                        <li sec:authorize="!isAuthenticated()" class="notLogin_m">
                            <span class="notLogin_message">플레이리스트에 음악 추가는 로그인 후 이용가능합니다.<br/><br/>로그인 후 '차트 목록' 메뉴를 통해 음악을 추가해주세요.</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 재생목록 표출시 html, css로 구현 가능한데 코드가 길어져서 자바스크립트 추가 -->
    <script>
        var audio = new Audio(); // 오디오 객체 생성
        var currentTrackId = null; // 현재 재생 중인 트랙 ID

        // DOM 요소들 가져오기
        var music = document.querySelector('.music-element');
        var playBtn = document.querySelector('.play');
        var seekbar = document.querySelector('.seekbar');
        var currentTime = document.querySelector('.current-time');
        var duration = document.querySelector('.duration');


    var currentHeightState = 0;
    var heightStates = [80, 480, 80, 30, 80]; // Height states to cycle through

    function handlePlaylist() {
      var footerContainer = document.querySelector('.footer_container');
      var showMyPlayList = document.querySelector('.show_myPlayList');
      var upIcon = document.querySelector('.fa-angle-up');
      var downIcon = document.querySelector('.fa-angle-down');

      // Increment the state counter
      currentHeightState = (currentHeightState + 1) % heightStates.length;

      // Set the height based on the current state
      footerContainer.style.height = heightStates[currentHeightState] + 'px';

      // Adjust the display of the playlist and icons based on the height state
      if (heightStates[currentHeightState] === 480) {
        showMyPlayList.style.display = 'block';
        upIcon.style.display = 'none';
        downIcon.style.display = 'block';
      } else if (heightStates[currentHeightState] === 80) {
        if (heightStates[currentHeightState - 1] === 480) { // Coming from 480
          showMyPlayList.style.display = 'none';
          upIcon.style.display = 'none';
          downIcon.style.display = 'block';
        } else { // Coming from 30 or other states
          showMyPlayList.style.display = 'none';
          upIcon.style.display = 'block';
          downIcon.style.display = 'none';
        }
      } else if (heightStates[currentHeightState] === 30) {
        showMyPlayList.style.display = 'none';
        upIcon.style.display = 'block';
        downIcon.style.display = 'none';
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      var upIcon = document.querySelector('.myPlayList-btn_icon .fa-angle-up');
      var downIcon = document.querySelector('.myPlayList-btn_icon .fa-angle-down');
      upIcon.style.display = 'block';
      downIcon.style.display = 'none';
    });

       var currentAudio = null; // 현재 재생 중인 오디오 요소를 저장할 변수


    var currentAudio = null; // 현재 재생 중인 오디오 요소를 저장할 변수

    // 음악 재생 버튼 클릭 시 처리
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.music_play').forEach(playButton => {
            playButton.addEventListener('click', () => {
                const audioPlayer = playButton.querySelector('audio');
                const playPauseBtn = playButton.querySelector('.play-pause');

                if (audioPlayer) {
                    // 현재 재생 중인 오디오를 정지합니다.
                    if (currentAudio && currentAudio !== audioPlayer) {
                        currentAudio.pause();
                        currentAudio.currentTime = 0;
                    }

                    // 선택한 오디오를 현재 재생 중인 오디오로 설정합니다.
                    currentAudio = audioPlayer;

                    if (audioPlayer.paused) {
                        audioPlayer.style.display = 'block';
                        audioPlayer.play();
                        playPauseBtn.querySelector('.fa-play').style.display = 'none';
                        playPauseBtn.querySelector('.fa-pause').style.display = 'inline-block';

                        // 재생 시 seekbar 업데이트
                        audioPlayer.addEventListener('timeupdate', () => {
                            updateSeekBar(audioPlayer);
                        });
                    } else {
                        audioPlayer.pause();
                        audioPlayer.style.display = 'none';
                        playPauseBtn.querySelector('.fa-play').style.display = 'inline-block';
                        playPauseBtn.querySelector('.fa-pause').style.display = 'none';
                    }
                }
            });
        });
    });

//반복
    function handleRepeat(repIcon) {
        if (currentAudio) {
            if (currentAudio.loop) {
                currentAudio.loop = false;
                repIcon.style.color = 'white';
            } else {
                currentAudio.loop = true;
                repIcon.style.color = 'skyblue';
            }
        }
    }

  // Function to play the next track
function playNextTrack() {
    if (!currentAudio) return; // If no current audio playing, exit

    // Get all music play elements
    var musicPlayElements = document.querySelectorAll('.music_play');

    // Find the next audio element to play
    var nextAudio = null;
    for (var i = 0; i < musicPlayElements.length; i++) {
        if (musicPlayElements[i].querySelector('audio') === currentAudio) {
            nextAudio = musicPlayElements[(i + 1) % musicPlayElements.length].querySelector('audio');
            break;
        }
    }

    if (!nextAudio) return; // If no next audio found, return

    // Stop current audio
    currentAudio.pause();
    currentAudio.currentTime = 0;
    currentAudio.style.display = 'none';

    // Start next audio
    currentAudio = nextAudio;
    currentAudio.play();
    currentAudio.style.display = 'block';

    // Update play-pause buttons
    document.querySelectorAll('.play-pause').forEach(btn => {
        btn.querySelector('.fa-play').style.display = 'inline-block';
        btn.querySelector('.fa-pause').style.display = 'none';
    });

    var playPauseBtn = nextAudio.parentElement.querySelector('.play-pause');
    playPauseBtn.querySelector('.fa-play').style.display = 'none';
    playPauseBtn.querySelector('.fa-pause').style.display = 'inline-block';

    // Update seekbar and time display
    updateSeekBar(nextAudio);

    // Event listener for time update
    nextAudio.addEventListener('timeupdate', function() {
        updateSeekBar(nextAudio);
    });
}

  // Event listener for "이후 곡" button
  document.querySelector('.afterMusic_icon').addEventListener('click', playNextTrack);

  // Function to play the previous track
 function playPreviousTrack() {
    if (!currentAudio) return; // If no current audio playing, exit

    // Get all music play elements
    var musicPlayElements = document.querySelectorAll('.music_play');

    // Find the previous audio element to play
    var previousAudio = null;
    for (var i = 0; i < musicPlayElements.length; i++) {
        if (musicPlayElements[i].querySelector('audio') === currentAudio) {
            // Calculate previous index, handle edge case for first element
            var previousIndex = (i - 1 + musicPlayElements.length) % musicPlayElements.length;
            previousAudio = musicPlayElements[previousIndex].querySelector('audio');
            break;
        }
    }

    if (!previousAudio) return; // If no previous audio found, return

    // Stop current audio
    currentAudio.pause();
    currentAudio.currentTime = 0;
    currentAudio.style.display = 'none';

    // Start previous audio
    currentAudio = previousAudio;
    currentAudio.play();
    currentAudio.style.display = 'block';

    // Update play-pause buttons
    document.querySelectorAll('.play-pause').forEach(btn => {
        btn.querySelector('.fa-play').style.display = 'inline-block';
        btn.querySelector('.fa-pause').style.display = 'none';
    });

    var playPauseBtn = previousAudio.parentElement.querySelector('.play-pause');
    playPauseBtn.querySelector('.fa-play').style.display = 'none';
    playPauseBtn.querySelector('.fa-pause').style.display = 'inline-block';

    // Update seekbar and time display
    updateSeekBar(previousAudio);

    // Event listener for time update
    previousAudio.addEventListener('timeupdate', function() {
        updateSeekBar(previousAudio);
    });
}

  // Event listener for "이전 곡" button
  document.querySelector('.BeforeMusic_icon').addEventListener('click', playPreviousTrack);

  // Function to update seekbar
function updateSeekBar(audio) {
    var seekbar = document.querySelector('.seekbar');
    var currentTime = document.querySelector('.current-time');
    var duration = document.querySelector('.duration');

    seekbar.value = (audio.currentTime / audio.duration) * 100;
    currentTime.textContent = formatTime(audio.currentTime);
    duration.textContent = formatTime(audio.duration);
}

// Event listener for seekbar input change
seekbar.addEventListener('input', function() {
  var seekTime = (seekbar.value / 100) * currentAudio.duration;
  currentAudio.currentTime = seekTime;
});

// Event listener for updating time display during playback
currentAudio.addEventListener('timeupdate', function() {
  updateSeekBar(currentAudio);
});

  // Function to format time (mm:ss)
  function formatTime(time) {
    var minutes = Math.floor(time / 60);
    var seconds = Math.floor(time % 60);
    return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
  }

  // 볼륨 조절
  var volumeRange = document.querySelector('.volume-range'); // 볼륨 조절 input 요소 가져오기
  var volumeIcon = document.querySelector('.volume'); // 볼륨 아이콘 요소 가져오기

  function handleVolumeUp() {
    var volumeRange = document.querySelector('.volume-range');
    if (currentAudio) {
        var newVolume = Math.min(currentAudio.volume + 0.1, 1); // Increase volume by 0.1
        currentAudio.volume = newVolume;
        volumeRange.value = newVolume * 100; // Update volume range input
    }
}

// Function to handle volume decrease
function handleVolumeDown() {
    var volumeRange = document.querySelector('.volume-range');
    if (currentAudio) {
        var newVolume = Math.max(currentAudio.volume - 0.1, 0); // Decrease volume by 0.1
        currentAudio.volume = newVolume;
        volumeRange.value = newVolume * 100; // Update volume range input
    }
}

// Function to handle volume change from the range input
function handleVolume() {
    var volumeRange = document.querySelector('.volume-range');
    if (currentAudio) {
        var newVolume = volumeRange.value / 100; // Convert range value to volume (0 to 1)
        currentAudio.volume = newVolume;
    }
}

  function toggleVolume() {
    var volumeBox = document.querySelector('.volume-box');
    volumeBox.classList.toggle('active'); // 볼륨 조절 박스 활성화/비활성화 토글
  }

  // 볼륨 아이콘 업데이트 함수
  function updateVolumeIcon() {
    if (currentAudio.volume === 0) {
      volumeIcon.classList.add('muted'); // 음소거 상태일 때 아이콘 변경
    } else {
      volumeIcon.classList.remove('muted'); // 음소거가 아닐 때 기본 아이콘 유지
    }
  }

  // 초기화 함수
  document.addEventListener('DOMContentLoaded', function() {
    // 초기 볼륨 설정 (예시: 80%)
    if (currentAudio) {
      currentAudio.volume = volumeRange.value / 100;
      updateVolumeIcon(); // 볼륨 아이콘 초기 설정
    }
  });
    </script>
</nav>